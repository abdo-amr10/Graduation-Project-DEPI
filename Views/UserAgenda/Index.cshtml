@* ==================== User Agenda Index View ==================== *@
@* Path: Views/UserAgenda/Index.cshtml *@
@model List<My_Uni_Hub.Models.Pages.UniversityAgenda>

@{
    ViewData["Title"] = "Agenda Calendar";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); color: #222; min-height:100vh; }
        .container { display:flex; min-height:100vh; }

        .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 70px; background-color: #0b1a3d; border-radius: 0 25px 0 0; display:flex; flex-direction:column; align-items:center; padding:15px 0; box-shadow: 3px 0 10px rgba(0,0,0,0.12); transition: width 300ms cubic-bezier(.2,.9,.2,1); overflow: visible; }
        .sidebar.expanded, .sidebar:hover { width:230px; align-items:flex-start; padding-left:18px; }
        .logo-section { margin-bottom: 35px; }
        .logo-img, .logo-small { width:50px; height:50px; border-radius:12px; object-fit:cover; }
        .logo-text{display:none;color:#ffffff;font-weight:700;font-size:16px}
        .sidebar.expanded .logo-text,.sidebar:hover .logo-text{display:none}

        .nav-menu { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; align-items:center; gap:12px; flex-grow:1; width:100%; padding-top:8px; }
        .bottom-menu { margin-top:auto; margin-bottom:30px; display:flex; flex-direction:column; gap:15px; align-items:center; }

        .nav-item { color:#bfc8da; font-size:18px; cursor:pointer; transition: all 0.2s ease; display:flex; align-items:center; gap:12px; width:100%; padding:8px 0; border-radius:10px; box-sizing:border-box; justify-content:center; }
        .sidebar.expanded .nav-item { justify-content:flex-start; padding-left:12px; }
        .nav-item i { width:36px; text-align:center; font-size:18px; }
        .nav-label { color:#bfc8da; font-size:15px; white-space:nowrap; display:none; opacity:0; transform:translateX(-6px); transition: opacity .2s, transform .2s; }
        .sidebar.expanded .nav-label, .sidebar:hover .nav-label { display:inline-block; opacity:1; transform:translateX(0); }
        .nav-item.active, .nav-item:hover { color:#ff8c00; background: rgba(255,140,0,0.06); }

        .main-content { margin-left:25px; padding:16px 24px 24px 24px; width:calc(100%); min-height:100vh; transition: margin-left .25s ease; }
        .sidebar.expanded ~ .main-content, .sidebar:hover ~ .main-content { margin-left:230px; }

        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .welcome-text { font-size:28px; font-weight:700; color:#2c3e50; }

        .agenda-grid { display:grid; grid-template-columns: 1fr 340px; gap:24px; }
        .agenda-card { background: white; border-radius:18px; padding:22px; box-shadow: 0 2px 15px rgba(0,0,0,0.06); }
        .agenda-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .agenda-header h2 { font-size:20px; font-weight:700; color:#2c3e50; }
        .btn { background:none; border:none; cursor:pointer; padding:6px 8px; border-radius:8px; }

        .qa-btn { display:flex; align-items:center; gap:10px; width:100%; padding:12px 14px; border-radius:12px; border:none; cursor:pointer; background:linear-gradient(90deg,#3b82f6,#06b6d4); color:#fff; font-weight:700; box-shadow:0 6px 20px rgba(59,130,246,0.12); transition:transform .12s ease, box-shadow .12s ease; }
        .qa-btn i{ width:28px;text-align:center; font-size:16px }
        .qa-btn.secondary{     background: linear-gradient(90deg, #0a1931, #1f3c88); box-shadow:0 6px 20px rgba(249,115,22,0.12); }
        .qa-btn:active{ transform:translateY(1px); }
        .qa-btn:focus{ outline:2px solid rgba(59,130,246,0.18); }

        .calendar-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
        .day-header { font-size:12px; font-weight:800; color:#7f8c8d; padding:6px 0; text-align:center; }
        .day-cell { min-height:74px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); border-radius:12px; padding:10px; position:relative; cursor:pointer; }
        .day-cell.today { background:#2b6fb3; color:#fff; }
        .day-cell .dot { width:8px; height:8px; background:#ff6b6b; border-radius:50%; position:absolute; bottom:8px; left:10px; }

        .side-right { display:flex; flex-direction:column; gap:18px; }
        .widget { background:white; border-radius:14px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
        .widget h3 { margin-bottom:12px; font-size:16px; }
        /* Event popup (small card) */
.event-backdrop {
  position: fixed;
  inset: 0;
  z-index: 1200;
  display: none;
}
.event-backdrop.visible { display: block; }

.event-popup {
  position: absolute;
  min-width: 260px;
  max-width: 360px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(20,40,60,0.18);
  padding: 12px 14px;
  z-index: 1201;
  transform-origin: top left;
  animation: popScale .12s ease;
  font-family: inherit;
  color: #123248;
}

.event-popup .popup-header {
  display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;
}
.event-popup .title { font-weight:800; font-size:14px; color:#063055 }
.event-popup .meta { font-size:12px; color:#586973; margin-bottom:8px }
.event-popup .lines { font-size:13px; color:#22313f; line-height:1.35; }
.event-popup .close-btn {
  background:#eef6ff;border:0;border-radius:8px;padding:6px 8px;cursor:pointer;color:#123248;font-weight:700;
}

        @@media (max-width:900px){ .agenda-grid { grid-template-columns:1fr; } .main-content{ margin-left:0; } .sidebar{position:relative;width:100%;height:auto;border-radius:0 0 12px 12px;} }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="leftSidebar">
            <div class="logo-section">
                <a href="@Url.Action("Index", "Home")" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit">
                    <img src="~/images/logo.png" alt="MyUni Hub logo" class="logo-img">
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item" data-key="home" data-href='@Url.Action("dashboard", "user")'>
                    <i class="fas fa-home"></i><span class="nav-label">Home</span>
                </li>

                <li class="nav-item" data-key="profile" data-href='@Url.Action("profile", "user")'>
                    <i class="fas fa-user"></i><span class="nav-label">Profile</span>
                </li>

                <li class="nav-item" data-key="mycourses" data-href='@Url.Action("courses", "user")'>
                    <i class="fas fa-book"></i><span class="nav-label">My Courses</span>
                </li>

                <li class="nav-item" data-key="ann" data-href='@Url.RouteUrl("announcements")'
                    onclick="window.location.href=this.getAttribute('data-href')"
                    style="cursor:pointer;">
                    <i class="fas fa-bullhorn"></i><span class="nav-label">Announcements</span>
                </li>

                <li class="nav-item" data-key="chat" data-href='@Url.Action("chat", "user")'>
                    <i class="fas fa-comments"></i><span class="nav-label">Chat</span>
                </li>

                <li class="nav-item" data-key="agenda" data-href="/useragenda">
                    <i class="fas fa-calendar-alt"></i><span class="nav-label">Agenda</span>
                </li>

                <li class="nav-item" data-key="opp" data-href="/opportunities">
                    <i class="fas fa-briefcase"></i><span class="nav-label">Opportunities</span>
                </li>

                <li class="nav-item" data-key="lost" data-href="/lost-and-found">
                    <i class="fas fa-box-open"></i><span class="nav-label">Lost &amp; Found</span>
                </li>
            </ul>


            <ul class="bottom-menu" role="menu">
                <li class="nav-item" role="menuitem" data-key="settings" data-href="user/profile"><i class="fas fa-cog"></i><span class="nav-label">Settings</span></li>
                <li class="nav-item" role="menuitem" data-key="logout" data-href="/Auth/login"><i class="fas fa-sign-out-alt"></i><span class="nav-label">Logout</span></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="welcome-text">Agenda Calendar</div>
            </div>

            <div class="agenda-grid">
                <div class="agenda-card">
                    <div class="agenda-header">
                        <button id="prev-month" class="btn" title="Previous"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="month-year">Month Year</h2>
                        <button id="next-month" class="btn" title="Next"><i class="fas fa-chevron-right"></i></button>
                    </div>

                    <div class="calendar-grid" id="calendar-grid">
                        <div class="day-header">Sun</div>
                        <div class="day-header">Mon</div>
                        <div class="day-header">Tue</div>
                        <div class="day-header">Wed</div>
                        <div class="day-header">Thu</div>
                        <div class="day-header">Fri</div>
                        <div class="day-header">Sat</div>
                    </div>
                </div>

                <div class="side-right">
                    <div class="widget">
                        <h3>📅 Upcoming Alerts</h3>
                        <ul id="alerts-list" style="list-style:none;padding:0;margin:0;"></ul>
                    </div>

                    <div class="widget">
                        <h3>Quick Actions</h3>
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
                            <button class="qa-btn" onclick="location.href='@Url.Action("courses", "user")'">
                                <i class="fas fa-book"></i>
                                <span>My Courses</span>
                            </button>
                            <button class="qa-btn secondary" data-href="/opportunities">
                                <i class="fas fa-briefcase"></i>
                                <span>Opportunities</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Event popup (backdrop + card) -->
<div id="event-backdrop" class="event-backdrop" aria-hidden="true">
  <div id="event-popup" class="event-popup" role="dialog" aria-modal="true" style="display:none">
    <div class="popup-header">
      <div class="title" id="popup-title">Event</div>
      <button id="popup-close" class="close-btn" aria-label="Close">OK</button>
    </div>
    <div class="meta" id="popup-date">Date</div>
    <div class="lines" id="popup-body">Details...</div>
  </div>
</div>

    <script>
        // Convert C# Model to JavaScript
        const events = @Html.Raw(Json.Serialize(Model.Select(e => new {
            date = e.StartDate.ToString("yyyy-MM-dd"),
            title = e.Title,
            type = e.Type,
            id = e.Id
        })));

        const monthYearEl = document.getElementById('month-year');
        const grid = document.getElementById('calendar-grid');
        const alertsList = document.getElementById('alerts-list');
        const prevBtn = document.getElementById('prev-month');
        const nextBtn = document.getElementById('next-month');

        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        function clearDates() {
            const nodes = Array.from(grid.children).slice(7);
            nodes.forEach(n => n.remove());
        }

        function renderCalendar(){
            monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            clearDates();

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDate = new Date(currentYear, currentMonth+1, 0).getDate();
            const startIndex = firstDay.getDay();

            for(let i=0;i<startIndex;i++){
                const e = document.createElement('div');
                e.className = 'day-cell';
                e.style.visibility = 'hidden';
                grid.appendChild(e);
            }

            for(let d=1; d<= lastDate; d++){
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.textContent = d;

                const mm = String(currentMonth+1).padStart(2,'0');
                const dd = String(d).padStart(2,'0');
                const iso = `${currentYear}-${mm}-${dd}`;

                const dayEvents = events.filter(ev => ev.date === iso);
                if(dayEvents.length){
                    const dot = document.createElement('div'); 
                    dot.className = 'dot';
                    cell.appendChild(dot);
                    cell.title = dayEvents.map(e=>e.title).join('\n');
                    cell.addEventListener('click', (ev) => {
    // ev.currentTarget هو العنصر اللي انضغط — نمرّره لتحديد موضع البوباب
    showEventPopup(dayEvents, iso, ev.currentTarget || ev.target);
});

                }

                if(d === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()){
                    cell.classList.add('today');
                }

                grid.appendChild(cell);
            }

            renderAlerts();
        }

        function renderAlerts(){
    alertsList.innerHTML = '';
    const todayISO = today.toISOString().split('T')[0];
    const upcoming = events
        .filter(e => e.date >= todayISO)
        .sort((a,b) => new Date(a.date) - new Date(b.date))
        .slice(0, 6);

    if (!upcoming.length) {
        alertsList.innerHTML = '<li style="padding:8px;color:#999">No upcoming events.</li>';
        return;
    }

    upcoming.forEach(ev => {
        const li = document.createElement('li');
        li.style.padding = '10px';
        li.style.borderLeft = '4px solid #3b82f6';
        li.style.marginBottom = '8px';
        li.style.borderRadius = '6px';
        li.style.background = '#f6f8ff';
        li.style.cursor = 'pointer';
        li.style.display = 'block';

        const date = new Date(ev.date + 'T00:00:00');
        const typeIcon = ev.type === 'Exam' ? '📝' : ev.type === 'Quiz' ? '✏️' : ev.type === 'Assignment' ? '📄' : '📅';

        li.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                <div style="flex:1">
                    <strong style="display:block;color:#063055">${typeIcon} ${date.toLocaleDateString(undefined,{month:'long',day:'numeric',year:'numeric'})}</strong>
                    <span style="color:#1f3b4a;display:block;margin-top:4px">${escapeHtml(ev.title || '(No title)')}</span>
                    <small style="color:#64748b;display:block;margin-top:6px">${escapeHtml(ev.type || 'Event')}</small>
                </div>
                <div style="margin-left:8px;display:flex;flex-direction:column;gap:6px">
                    <button class="view-btn" style="background:#e6f2ff;border:0;border-radius:8px;padding:6px 8px;cursor:pointer;color:#063055;font-weight:700">View</button>
                </div>
            </div>
        `;

        // click on whole li opens popup (anchor = li)
        li.addEventListener('click', (e) => {
            // prevent double-handling when clicking the inner "View" button (we let it also open popup)
            e.stopPropagation();
            // find all events on that exact date (could be multiple)
            const sameDateEvents = events.filter(x => x.date === ev.date);
            showEventPopup(sameDateEvents, ev.date, li);
        });

        // the View button could also navigate to details of the first event — optional:
        const viewBtn = li.querySelector('.view-btn');
        if(viewBtn){
            // stop propagation to avoid duplicate event firing
            viewBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // open popup instead of direct navigation:
                const sameDateEvents = events.filter(x => x.date === ev.date);
                showEventPopup(sameDateEvents, ev.date, li);

                // OR if you prefer to go to details page for the first event, uncomment:
                // window.location.href = '@Url.Action("Details","UserAgenda")/' + ev.id;
            });
        }

        alertsList.appendChild(li);
    });
}

document.addEventListener("click", function (e) {
    const btn = e.target.closest("[data-href]");
    if (btn) {
        window.location.href = btn.getAttribute("data-href");
    }
});


        // ===== popup helpers =====
const backdrop = document.getElementById('event-backdrop');
const popup = document.getElementById('event-popup');
const popupTitle = document.getElementById('popup-title');
const popupDate = document.getElementById('popup-date');
const popupBody = document.getElementById('popup-body');
const popupClose = document.getElementById('popup-close');

function showEventPopup(eventsArray, isoDate, anchorEl) {
    popupTitle.textContent = `${eventsArray.length > 1 ? eventsArray.length + ' events' : 'Event'}`;
    const d = new Date(isoDate + 'T00:00:00');
    popupDate.textContent = d.toLocaleDateString(undefined, { month:'long', day:'numeric', year:'numeric' });

    popupBody.innerHTML = eventsArray.map(ev => {
        const type = ev.type || 'Event';
        const title = ev.title || '(No title)';
        return `<div style="margin-bottom:8px">
                    <strong style="display:block">${escapeHtml(title)}</strong>
                    <small style="color:#64748b">${escapeHtml(type)}</small>
                </div>`;
    }).join('');

    // show
    backdrop.classList.add('visible');
    backdrop.setAttribute('aria-hidden','false');
    popup.style.display = 'block';

    // position near clicked cell
    positionPopupNear(anchorEl);

    // add listeners
    setTimeout(()=> {
        document.addEventListener('keydown', onKeyDown);
        backdrop.addEventListener('click', onBackdropClick);
        popupClose.addEventListener('click', hidePopup);
    }, 10);
}

function hidePopup() {
    backdrop.classList.remove('visible');
    backdrop.setAttribute('aria-hidden','true');
    popup.style.display = 'none';
    document.removeEventListener('keydown', onKeyDown);
    backdrop.removeEventListener('click', onBackdropClick);
    popupClose.removeEventListener('click', hidePopup);
}

function onBackdropClick(e){
    if (!popup.contains(e.target)) hidePopup();
}

function onKeyDown(e){
    if (e.key === 'Escape') hidePopup();
}

function positionPopupNear(anchorEl) {
    const rect = (anchorEl && anchorEl.getBoundingClientRect) ? anchorEl.getBoundingClientRect() : null;
    const popupRect = popup.getBoundingClientRect();
    const viewportW = window.innerWidth;
    const viewportH = window.innerHeight;

    // default center
    let left = (viewportW - popupRect.width) / 2;
    let top = (viewportH - popupRect.height) / 2;

    if (rect) {
        left = rect.right + 12;
        top = rect.top;

        if (left + popupRect.width > viewportW - 12) {
            left = rect.left - popupRect.width - 12;
        }
        if (left < 12) left = 12;
        if (top + popupRect.height > viewportH - 12) {
            top = viewportH - popupRect.height - 12;
        }
        if (top < 12) top = 12;
    }

    popup.style.left = `${Math.round(left)}px`;
    popup.style.top = `${Math.round(top)}px`;
}

// small helper to avoid HTML injection
function escapeHtml(s){
    if(!s) return '';
    return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}


        prevBtn.addEventListener('click', ()=>{ 
            currentMonth--; 
            if(currentMonth<0){ currentMonth=11; currentYear--; } 
            renderCalendar(); 
        });
        
        nextBtn.addEventListener('click', ()=>{ 
            currentMonth++; 
            if(currentMonth>11){ currentMonth=0; currentYear++; } 
            renderCalendar(); 
        });

        // Sidebar interactions
        const sidebar = document.getElementById('leftSidebar');
        sidebar.addEventListener('mouseenter', ()=> sidebar.classList.add('expanded'));
        sidebar.addEventListener('mouseleave', ()=> sidebar.classList.remove('expanded'));

        renderCalendar();
    </script>
    <script>
(function () {
    // كل عناصر السايدبار
    const items = document.querySelectorAll('.nav-item');

    // ابعت المسار الحقيقي للصفحة بدون / في الآخر
    const current = window.location.pathname.replace(/\/$/, "").toLowerCase();

    // شيل active من الكل
    items.forEach(i => i.classList.remove("active"));

    let matched = null;

    // 1) أولاً — طابق link كامل مع data-href
    items.forEach(i => {
        const href = i.dataset.href;
        if (!href) return;

        try {
            // نحلل الرابط لحماية من الروابط المطلقة
            const a = document.createElement("a");
            a.href = href;
            const path = a.pathname.replace(/\/$/, "").toLowerCase();

            if (path === current) matched = i;
        } catch { }
    });

    // 2) لو لسه ملقاش — طابق آخر جزء مع الـ data-key
    if (!matched) {
        const last = current.split("/").pop();
        matched = Array.from(items).find(i =>
            (i.dataset.key || "").toLowerCase() === last
        );
    }

    // 3) لو لسه — طابق بادئة (لصفحات الأقسام مثل /opportunities/5/edit)
    if (!matched) {
        matched = Array.from(items).find(i => {
            const href = i.dataset.href;
            if (!href) return false;

            const a = document.createElement("a");
            a.href = href;
            const path = a.pathname.replace(/\/$/, "").toLowerCase();

            return current.startsWith(path);
        });
    }

    // لو وجدنا العنصر — فعّله
    if (matched) matched.classList.add("active");

})();
</script>

</body>
</html>